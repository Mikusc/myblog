<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shuttle Bus Next Departure</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700&family=Manrope:wght@400;600;700&display=swap');

    :root{
      --bg-1: #f7f1e7;
      --bg-2: #e4f1f2;
      --ink: #1c2b2d;
      --muted: #4f5d5e;
      --card: #ffffff;
      --accent: #2d6a6f;
      --accent-2: #e39c44;
      --accent-3: #f5e6c7;
      --ring: rgba(45, 106, 111, 0.2);
      --shadow: 0 18px 45px rgba(12, 28, 32, 0.12);
    }

    body {
      font-family: "Manrope", "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      background: radial-gradient(900px 400px at 10% -10%, #fff6df 0%, transparent 60%),
        radial-gradient(800px 380px at 110% 0%, #e7f6f6 0%, transparent 65%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      color: var(--ink);
      line-height: 1.5;
      position: relative;
      overflow-x: hidden;
    }
    body::before,
    body::after{
      content: "";
      position: absolute;
      z-index: 0;
      width: 240px;
      height: 240px;
      border-radius: 50%;
      filter: blur(20px);
      opacity: 0.35;
    }
    body::before{
      top: 80px;
      left: -60px;
      background: #ffe6bf;
    }
    body::after{
      bottom: 40px;
      right: -80px;
      background: #d5f0f2;
    }
    header {
      text-align: center;
      margin: 16px auto 28px;
      max-width: 640px;
      position: relative;
      z-index: 1;
      animation: fadeUp 0.7s ease both;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: clamp(1.9rem, 4vw, 2.6rem);
      font-family: "Fraunces", "Georgia", serif;
      letter-spacing: 0.5px;
    }
    header p{
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }
    .container {
      max-width: 640px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.92);
      padding: 22px 22px 26px;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(6px);
      animation: liftIn 0.65s ease both;
    }
    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    select, button, input[type="time"] {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #d3d9dc;
      background: #fff;
      font-family: "Manrope", "Segoe UI", sans-serif;
      color: var(--ink);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
    select:focus-visible,
    button:focus-visible,
    input[type="time"]:focus-visible{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--ring);
    }
    button{
      cursor: pointer;
      background: linear-gradient(135deg, #2d6a6f, #3f868b);
      color: #fff;
      border: none;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    button:hover{
      transform: translateY(-1px);
    }
    button:active{
      transform: translateY(0);
    }
    .times {
      font-size: 1.05rem;
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, #fef8ec, #f4fbfb);
      border: 1px solid rgba(45, 106, 111, 0.12);
      display: grid;
      gap: 6px;
    }
    .times span {
      display: block;
      color: #243637;
    }
    .times span strong{
      color: var(--accent);
    }
    footer {
      margin-top: 30px;
      font-size: 0.8rem;
      text-align: center;
      color: #6a7374;
    }
  
    /* Timetable (full schedule) */
    .secondary-btn{
      width: 100%;
      margin-top: 12px;
      padding: 12px 14px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid #d8dee0;
      background: #ffffff;
      color: var(--accent);
      font-weight: 700;
      cursor: pointer;
    }
    .tt-controls{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0;
    }
    .tt-controls label{
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .time-chip{
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f2f5f6;
      border: 1px solid #e2e6e7;
      font-size: 0.95rem;
      animation: chipIn 0.35s ease;
    }
    .time-chip.next-time{
      background: var(--accent-3);
      border: 1px solid #e1c989;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(227, 156, 68, 0.18);
    }
    .next-badge{
      margin-left: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ffe7a3;
      color: #6f4f00;
      font-size: 0.72rem;
      font-weight: 700;
    }
    .tt-input{
      padding: 10px 14px;
      font-size: 1rem;
      border: 1px solid #d3d9dc;
      border-radius: 10px;
    }
    .tt-btn{
      padding: 10px 14px;
      font-size: 0.95rem;
      border-radius: 10px;
      border: 1px solid #d3d9dc;
      background: #ffffff;
      color: var(--accent);
      font-weight: 700;
      cursor: pointer;
    }
    .tt-btn:hover{
      background: #f1f6f7;
    }
    .tt-search-result{
      margin-top: 8px;
      font-size: 0.95rem;
      color: #3b4b4c;
    }
    .section-title{
      font-weight: 700;
      margin: 12px 0 6px 0;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-size: 0.78rem;
    }
    .timetable-panel{
      background: #fbfdfd;
      border: 1px solid #eef2f3;
      border-radius: 14px;
      padding: 14px 14px 16px;
      margin-top: 0;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      pointer-events: none;
      transform: translateY(-6px);
      transition: max-height 0.35s ease, opacity 0.25s ease, transform 0.25s ease, margin-top 0.25s ease;
    }
    .timetable-panel.open{
      margin-top: 12px;
      max-height: 1200px;
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    #timetableTable{
      margin-top: 6px;
    }
    #timetableTable .time-chip{
      font-size: 0.9rem;
    }
    @keyframes liftIn{
      from{ opacity: 0; transform: translateY(14px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeUp{
      from{ opacity: 0; transform: translateY(10px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    @keyframes chipIn{
      from{ opacity: 0; transform: translateY(6px) scale(0.98); }
      to{ opacity: 1; transform: translateY(0) scale(1); }
    }
    @media (max-width: 600px){
      body{ padding: 18px; }
      .container{ padding: 18px; }
      .tt-controls{ gap: 8px; }
      .secondary-btn{ padding: 12px; }
      select, button, input[type="time"]{ width: 100%; }
    }

    /* Language & Theme Controls */
    .top-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 100;
      animation: fadeUp 0.8s ease backwards;
    }
    .icon-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--ink);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transition: all 0.25s ease;
      padding: 0;
    }
    .icon-btn:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .icon-btn svg {
      width: 20px;
      height: 20px;
      stroke: var(--ink);
    }
    
    /* Dark Mode Overrides */
    body.dark-mode {
      --bg-1: #1a1f20;
      --bg-2: #0f1516;
      --ink: #e0e6e7;
      --muted: #aab6b8;
      --card: #1c2b2d;
      --accent-3: #2d3b3d;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
      --ring: rgba(120, 200, 207, 0.3);
    }
    body.dark-mode::before { background: #6b4c20; opacity: 0.15; }
    body.dark-mode::after { background: #263537; opacity: 0.2; }
    
    body.dark-mode .container {
      background: rgba(30, 40, 42, 0.85);
      border-color: rgba(255,255,255,0.08);
    }
    body.dark-mode select, 
    body.dark-mode input {
      background: #263436;
      border-color: #3f4e50;
      color: #fff;
    }
    body.dark-mode .icon-btn {
      background: rgba(30, 40, 42, 0.6);
      border-color: rgba(255,255,255,0.08);
    }
    body.dark-mode .icon-btn:hover {
      background: #354547;
      color: #fff;
    }
    body.dark-mode .times {
      background: #232d2f;
      border-color: rgba(255,255,255,0.05);
    }
    body.dark-mode .times span { color: #ccd6d8; }
    body.dark-mode .times span strong { color: #6dbfb8; }
    
    body.dark-mode .secondary-btn,
    body.dark-mode .tt-btn {
      background: #263436;
      border-color: #3f4e50;
      color: #92cacc;
    }
    body.dark-mode .secondary-btn:hover,
    body.dark-mode .tt-btn:hover {
      background: #2f3e40;
    }
    
    body.dark-mode .timetable-panel {
      background: #1e282a;
      border-color: #2f3e40;
    }
    body.dark-mode .time-chip {
      background: #2a3638;
      border-color: #3f4e50;
      color: #d0dbe0;
    }
    body.dark-mode .time-chip.next-time {
      background: #3d5254; /* Darker green background */
      border-color: #c9a35b;
      color: #fff;
    }
    body.dark-mode .next-badge {
      background: #c9a35b;
      color: #1a1f20;
    }
    body.dark-mode .tt-search-result { color: #b0bfc0; }
  </style>
</head>
<body>
  <div class="top-controls">
    <button class="icon-btn" id="langBtn" title="Change Language" aria-label="Change Language">
      <span style="font-size:0.9rem; font-weight:700;">文/A</span>
    </button>
    <button class="icon-btn" id="themeBtn" title="Toggle Dark Mode" aria-label="Toggle Dark Mode">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>
  </div>
  <header>
    <h1 data-i18n="title">Shuttle Bus Next Departure</h1>
    <p data-i18n="subtitle">Get the next shuttle bus times from HOLA or UNNC based on your location and the current time.</p>
  </header>
  <div class="container">
    <div class="field">
      <label for="locationSelect" data-i18n="labelLocation">Departure Location:</label>
      <select id="locationSelect">
        <option value="auto" data-i18n="optionAuto">Auto detect</option>
        <option value="HOLA" data-i18n="optionHola">HOLA (West Gate)</option>
        <option value="UNNC" data-i18n="optionUnnc">UNNC (Building 23)</option>
      </select>
    </div>
    <div class="field">
      <button id="refreshBtn" data-i18n="btnRefresh">Refresh Times</button>
    </div>
    <div class="times" id="timesDisplay">
      <!-- times will appear here -->
    </div>
    <!-- status messages (e.g. geolocation results) -->
    <div class="status" id="statusMessage" style="margin-top:10px;font-size:0.9rem;color:#555;"></div>

    <button id="toggleTimetable" class="secondary-btn" type="button" data-i18n="btnTimetableShow">查看总时刻表</button>

    <div id="timetablePanel" class="timetable-panel">
      <div class="tt-controls">
        <label>
          <span data-i18n="ttLabelLoc">站点：</span>
          <select id="ttLocation">
            <option value="HOLA" data-i18n="ttOptionHola">HOLA → 校园</option>
            <option value="UNNC" data-i18n="ttOptionUnnc">校园 → HOLA</option>
          </select>
        </label>

        <label>
          <span data-i18n="ttLabelDay">日期类型：</span>
          <select id="ttDayType">
            <option value="auto" data-i18n="ttOptionAuto">自动（按今天）</option>
            <option value="weekday" data-i18n="ttOptionWeekday">周一至周五</option>
            <option value="weekend" data-i18n="ttOptionWeekend">周末</option>
          </select>
        </label>
      </div>

      <div class="tt-controls">
        <label>
          <span data-i18n="ttLabelSearch">搜索时间：</span>
          <input id="ttSearchInput" class="tt-input" type="time" step="60" placeholder="13:20">
        </label>
        <button id="ttSearchBtn" class="tt-btn" type="button" data-i18n="ttBtnSearch">搜索</button>
      </div>
      <div id="ttSearchResult" class="tt-search-result"></div>

      <div id="timetableTable"></div>
      <div style="font-size:0.8rem;color:#666;margin-top:10px;" data-i18n="ttNote">
        * 时间按你设备本地时区显示
      </div>
    </div>

  </div>
  <footer>
    <p data-i18n="footer">Schedule information sourced from the on‑campus shuttle timetable as of October 2025. Times are shown in your local time zone.</p>
  </footer>
  <script>
    // Coordinates for the two boarding locations. These are approximate and only used
    // to determine which stop is closer when auto detecting.
    const LOCATION_COORDS = {
      // Updated coordinates provided by the user (longitude, latitude).
      // We assign lng to the provided longitude value and lat to the provided latitude value.
      HOLA: { lat: 29.79190, lng: 121.53518 },       // West Gate of HOLA
      UNNC: { lat: 29.79979, lng: 121.56306 }        // Building 23 (UNNC campus)
    };

    // Schedules. Times are strings in HH:MM format. The weekday HOLA schedule
    // distinguishes between morning peak and non‑peak.
    const schedules = {
      HOLA: {
        morningPeak: [
          '07:55','08:00','08:05','08:10','08:15','08:20','08:25'
        ],
        weekday: [
          '09:00','09:30','10:00','10:30','11:00',
          '11:30','12:01','12:30','13:00','13:30',
          '14:00','14:30','15:00','15:30','16:00',
          '16:30','17:00','17:30','18:00','18:30',
          '19:00','19:30','20:00','20:30','21:00','21:30','22:00'
        ],
        weekend: [
          '08:30','09:00','09:30','10:00','10:30',
          '11:00','11:30','12:01','12:30','13:00',
          '13:30','14:00','14:30','15:00','15:30',
          '16:00','16:30','17:00','17:30','18:00',
          '18:30','19:00','19:30','20:00','20:30','21:00','21:30','22:00'
        ]
      },
      UNNC: {
        weekday: [
          '09:30','10:00','10:30','11:00','11:20',
          '11:50','12:20','12:50','13:20','13:50',
          '14:20','14:50','15:20','15:50','16:20',
          '16:50','17:20','17:50','18:20','18:50',
          '19:20','19:50','20:10','20:30','20:45',
          '21:00','21:30','22:00','22:30'
        ],
        weekend: [
          '09:00','09:30','10:00','10:30','11:00',
          '11:30','12:01','12:30','13:00','13:30',
          '14:00','14:30','15:00','15:30','16:00',
          '16:30','17:00','17:30','18:00','18:30',
          '19:00','19:30','20:00','20:30','21:00',
          '21:30','22:00','22:30'
        ]
      }
    };

    const translations = {
      zh: {
        title: "下一班校车",
        subtitle: "获取下一班往返 HOLA 和 UNNC 的校车时间。",
        labelLocation: "出发站点：",
        optionAuto: "自动检测",
        optionHola: "HOLA (西门)",
        optionUnnc: "UNNC (23号楼)",
        btnRefresh: "刷新时间",
        btnTimetableShow: "查看总时刻表",
        btnTimetableHide: "收起总时刻表",
        footer: "时刻表通过2025年10月校内班车时刻表整理。",
        currTime: "当前时间：",
        depLoc: "出发站点：",
        todayEnd: "今日班车已全部结束。",
        nextBus: "下一班：",
        minLeft: "距离该班还有：",
        min: " 分钟",
        noMoreNext: "之后已无班车。",
        nextTwoBus: "下两班：", 
        ttLabelLoc: "站点：",
        ttLabelDay: "日期类型：",
        ttLabelSearch: "搜索时间：",
        ttOptionHola: "HOLA → 校园",
        ttOptionUnnc: "校园 → HOLA",
        ttOptionAuto: "自动（按今天）",
        ttOptionWeekday: "周一至周五",
        ttOptionWeekend: "周末",
        ttBtnSearch: "搜索",
        ttNote: "* 时间按你设备本地时区显示",
        geoAutoSuccess: "自动定位成功，距离最近的站点是 {stop}（约 {dist} 公里）。",
        geoFail: "无法获取定位信息，已默认采用 HOLA。",
        geoErr: "未允许定位或发生错误，已默认采用 HOLA。",
        enterTime: "请输入时间（例如 13:20）。",
        noTimes: "当前设置下没有班车时刻。",
        prevBus: "上一班",
        nextBusLabel: "下一班",
        searchResultPrefix: "搜索时间",
        none: "无",
        ttTitle: "总时刻表",
        sectionWeekend: "周末",
        sectionMorningPeak: "早高峰 (07:55–08:25)",
        sectionOffPeak: "非高峰",
        sectionWeekday: "周一至周五"
      },
      en: {
        title: "Bus Next Departure",
        subtitle: "Get next shuttle bus times from HOLA or UNNC.",
        labelLocation: "Departure Location:",
        optionAuto: "Auto detect",
        optionHola: "HOLA (West Gate)",
        optionUnnc: "UNNC (Building 23)",
        btnRefresh: "Refresh Times",
        btnTimetableShow: "View Full Timetable",
        btnTimetableHide: "Hide Timetable",
        footer: "Schedule based on Oct 2025 timetable. Local time zone shown.",
        currTime: "Time: ",
        depLoc: "From: ",
        todayEnd: "No more buses today.",
        nextBus: "Next: ",
        minLeft: "Leaves in: ",
        min: " min",
        noMoreNext: "No more buses after this.",
        nextTwoBus: "Next two: ",
        ttLabelLoc: "Stop:",
        ttLabelDay: "Day Type:",
        ttLabelSearch: "Search:",
        ttOptionHola: "HOLA -> UNNC",
        ttOptionUnnc: "UNNC -> HOLA",
        ttOptionAuto: "Auto (Today)",
        ttOptionWeekday: "Weekday",
        ttOptionWeekend: "Weekend",
        ttBtnSearch: "Search",
        ttNote: "* Times shown in your local time zone.",
        geoAutoSuccess: "Auto-detected: {stop} (approx {dist} km).",
        geoFail: "Geolocation failed, defaulting to HOLA.",
        geoErr: "Geolocation denied/error, defaulting to HOLA.",
        enterTime: "Enter time (e.g. 13:20).",
        noTimes: "No schedule found.",
        prevBus: "Previous",
        nextBusLabel: "Next",
        searchResultPrefix: "Search for",
        none: "None",
        ttTitle: "Timetable",
        sectionWeekend: "Weekend",
        sectionMorningPeak: "Morning Peak (07:55-08:25)",
        sectionOffPeak: "Off-peak",
        sectionWeekday: "Weekday"
      }
    };

    let currentLang = 'zh';

    function setLanguage(lang) {
      if (!translations[lang]) return;
      currentLang = lang;
      
      const t = translations[lang];
      
      // Update data-i18n elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
          if (key === 'btnTimetableShow') {
             const panel = document.getElementById("timetablePanel");
             el.textContent = panel.classList.contains("open") ? t.btnTimetableHide : t.btnTimetableShow;
          } else {
             el.textContent = t[key];
          }
        }
      });
      
      refreshDisplay();
      if (document.getElementById("timetablePanel").classList.contains("open")) {
        renderTimetable();
        const searchRes = document.getElementById("ttSearchResult");
        if(searchRes.innerHTML !== "") runSearch();
      }
    }

    // Toggle Language
    document.getElementById('langBtn').addEventListener('click', () => {
      const newLang = currentLang === 'zh' ? 'en' : 'zh';
      setLanguage(newLang);
    });

    // Toggle Theme
    document.getElementById('themeBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      const btn = document.getElementById('themeBtn');
      if (isDark) {
         btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      } else {
        btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
      }
    });

    // Utility to convert HH:MM string to a Date object on the current day
    function parseTimeToDate(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
    }

    // Compute great‑circle distance between two lat/lng points using Haversine formula
    function haversineDistance(coord1, coord2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371; // Earth radius in km
      const dLat = toRad(coord2.lat - coord1.lat);
      const dLon = toRad(coord2.lng - coord1.lng);
      const lat1 = toRad(coord1.lat);
      const lat2 = toRad(coord2.lat);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Determine which schedule applies based on location and day/time
    function getSchedule(location, now) {
      const day = now.getDay(); // 0 = Sunday, 6 = Saturday
      const isWeekend = (day === 0 || day === 6);

      if (location === 'HOLA') {
        if (isWeekend) return schedules.HOLA.weekend;

        const endPeak = parseTimeToDate('08:30');

        // 工作日：早高峰结束前，把早高峰+非高峰拼在一起
        if (now < endPeak) {
          return schedules.HOLA.morningPeak.concat(schedules.HOLA.weekday);
        }

        // 早高峰结束后就只看非高峰
        return schedules.HOLA.weekday;
      }

      if (location === 'UNNC') {
        return isWeekend ? schedules.UNNC.weekend : schedules.UNNC.weekday;
      }

      return [];
    }


    // Given a list of times and the current time, return the next two departures.
    function getNextDepartures(scheduleTimes, now) {
      const departures = scheduleTimes.map(t => ({ time: t, date: parseTimeToDate(t) }))
        .filter(obj => obj.date >= now)
        .sort((a, b) => a.date - b.date);
      return departures.slice(0, 2);
    }

    function timeToMinutes(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return (h * 60) + m;
    }

    function parseSearchInput(value) {
      if (!value) return null;
      const match = value.match(/^(\d{1,2}):(\d{2})$/);
      if (!match) return null;
      const h = Number(match[1]);
      const m = Number(match[2]);
      if (Number.isNaN(h) || Number.isNaN(m) || h < 0 || h > 23 || m < 0 || m > 59) return null;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    // Format Date object to HH:MM display
    function formatTime(date) {
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      return `${h}:${m}`;
    }

    // Determine selected location based on user choice or auto detection.
    // When auto detection is used, a status message will explain the result or fallback.
    function determineLocation(callback) {
      const selectValue = document.getElementById('locationSelect').value;
      const statusDiv = document.getElementById('statusMessage');
      const t = translations[currentLang];
      
      statusDiv.textContent = '';
      if (selectValue === 'auto') {
        if (!navigator.geolocation) {
          statusDiv.textContent = t.geoFail;
          callback({ location: 'HOLA' });
          return;
        }
        navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;
          const userCoord = { lat: latitude, lng: longitude };
          const distToHOLA = haversineDistance(userCoord, LOCATION_COORDS.HOLA);
          const distToUNNC = haversineDistance(userCoord, LOCATION_COORDS.UNNC);
          const selected = distToHOLA <= distToUNNC ? 'HOLA' : 'UNNC';
          const nearest = selected === 'HOLA' ? 'HOLA' : 'UNNC';
          const nearestDist = (selected === 'HOLA' ? distToHOLA : distToUNNC).toFixed(2);
          
          let msg = t.geoAutoSuccess.replace('{stop}', nearest).replace('{dist}', nearestDist);
          statusDiv.textContent = msg;
          callback({ location: selected });
        }, err => {
          statusDiv.textContent = t.geoErr;
          callback({ location: 'HOLA' });
        });
      } else {
        callback({ location: selectValue });
      }
    }

    // Main function to refresh display
    function refreshDisplay() {
      const now = new Date();
      determineLocation(({ location }) => {
        const schedule = getSchedule(location, now);
        const next = getNextDepartures(schedule, now);
        const timesDiv = document.getElementById('timesDisplay');
        const t = translations[currentLang];
        
        let html = '';
        html += `<span>${t.currTime}${formatTime(now)}</span>`;
        html += `<span>${t.depLoc}<strong>${location}</strong></span>`;
        
        if (next.length === 0) {
          html += `<span>${t.todayEnd}</span>`;
        } else if (next.length === 1) {
          html += `<span>${t.nextBus}<strong>${next[0].time}</strong></span>`;
          const diffMs = next[0].date - now;
          const diffMin = diffMs <= 0 ? 0 : Math.ceil(diffMs / 60000);
          html += `<span>${t.minLeft}<strong>${diffMin}</strong>${t.min}</span>`;
          html += `<span>${t.noMoreNext}</span>`;
        } else {
          html += `<span>${t.nextBus}<strong>${next[0].time}</strong></span>`;
          const diffMs = next[0].date - now;
          const diffMin = diffMs <= 0 ? 0 : Math.ceil(diffMs / 60000);
          html += `<span>${t.minLeft}<strong>${diffMin}</strong>${t.min}</span>`;
          html += `<span>${t.nextTwoBus}<strong>${next[1].time}</strong></span>`;
        }
        timesDiv.innerHTML = html;

        const panel = document.getElementById("timetablePanel");
        if (panel.classList.contains("open")) {
          renderTimetable();
        }
      });
    }

    // Event handlers
    document.getElementById('refreshBtn').addEventListener('click', refreshDisplay);
    document.getElementById('locationSelect').addEventListener('change', refreshDisplay);

    // Initial load and periodic refresh every minute
    setLanguage('zh');
    setInterval(refreshDisplay, 60000);

    // ===== Full timetable (collapsible) =====
    function isWeekendDay(d) { return d === 0 || d === 6; }

    function buildTimetableData(location, dayType, now) {
      const t = translations[currentLang];
      const useWeekend =
        dayType === 'weekend' ? true :
        dayType === 'weekday' ? false :
        isWeekendDay(now.getDay()); // auto

      if (location === 'HOLA') {
        if (useWeekend) {
          return {
            title: `HOLA (${t.sectionWeekend})`,
            sections: [{ name: t.sectionWeekend, times: schedules.HOLA.weekend }]
          };
        }
        return {
          title: `HOLA (${t.sectionWeekday})`,
          sections: [
            { name: t.sectionMorningPeak, times: schedules.HOLA.morningPeak },
            { name: t.sectionOffPeak, times: schedules.HOLA.weekday }
          ]
        };
      }

      if (location === 'UNNC') {
        if (useWeekend) {
          return {
            title: `UNNC (${t.sectionWeekend})`,
            sections: [{ name: t.sectionWeekend, times: schedules.UNNC.weekend }]
          };
        }
        return {
          title: `UNNC (${t.sectionWeekday})`,
          sections: [{ name: t.sectionWeekday, times: schedules.UNNC.weekday }]
        };
      }

      return { title: "", sections: [] };
    }

    function getTimetableTimes(location, dayType, now) {
      const data = buildTimetableData(location, dayType, now);
      return data.sections.flatMap(section => section.times);
    }

    function findSurroundingTimes(times, targetTime) {
      const targetMin = timeToMinutes(targetTime);
      let previous = null;
      let next = null;
      for (const t of times) {
        const minutes = timeToMinutes(t);
        if (minutes <= targetMin) {
          previous = t;
        }
        if (minutes >= targetMin) {
          next = t;
          break;
        }
      }
      if (previous && next && previous === next) {
        const idx = times.indexOf(next);
        if (idx >= 0 && idx < times.length - 1) {
          next = times[idx + 1];
        }
      }
      return { previous, next };
    }

    function runSearch() {
      const t = translations[currentLang];
      const input = document.getElementById("ttSearchInput").value;
      const normalized = parseSearchInput(input);
      const resultDiv = document.getElementById("ttSearchResult");
      if (!normalized) {
        resultDiv.textContent = t.enterTime;
        return;
      }
      const loc = document.getElementById("ttLocation").value;
      const dayType = document.getElementById("ttDayType").value;
      const now = new Date();
      const times = getTimetableTimes(loc, dayType, now);
      if (times.length === 0) {
        resultDiv.textContent = t.noTimes;
        return;
      }
      const surrounding = findSurroundingTimes(times, normalized);
      const prevText = surrounding.previous ? surrounding.previous : t.none;
      const nextText = surrounding.next ? surrounding.next : t.none;
      resultDiv.innerHTML = `${t.searchResultPrefix} <strong>${normalized}</strong>：${t.prevBus} <span class="time-chip">${prevText}</span> ${t.nextBusLabel} <span class="time-chip">${nextText}</span>`;
    }

    function renderTimetable() {
      const t = translations[currentLang];
      const loc = document.getElementById("ttLocation").value;
      const dayType = document.getElementById("ttDayType").value;
      const now = new Date();
      const data = buildTimetableData(loc, dayType, now);
      const times = data.sections.flatMap(section => section.times);
      const nextTime = getNextDepartures(times, now)[0]?.time || null;

      document.getElementById("timetableTable").innerHTML = `
        <div style="font-weight:700;margin:0 0 8px 0;">${t.ttTitle}: ${data.title}</div>
        ${data.sections.map(sec => `
          <div style="margin:10px 0;">
            <div class="section-title">${sec.name}</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              ${sec.times.map(timeStr => {
                const isNext = nextTime && timeStr === nextTime;
                return `<span class="time-chip ${isNext ? 'next-time' : ''}">${timeStr}${isNext ? `<span class="next-badge">${t.nextBusLabel}</span>` : ''}</span>`;
              }).join("")}
            </div>
          </div>
        `).join("")}
      `;
    }

    document.getElementById("toggleTimetable").addEventListener("click", () => {
      const panel = document.getElementById("timetablePanel");
      const btn = document.getElementById("toggleTimetable");
      const t = translations[currentLang];
      const open = panel.classList.contains("open");
      panel.classList.toggle("open", !open);
      btn.textContent = open ? t.btnTimetableShow : t.btnTimetableHide;
      if (!open) {
        // 默认跟随当前选择站点
        const current = document.getElementById('locationSelect').value;
        document.getElementById('ttLocation').value = (current === 'UNNC') ? 'UNNC' : 'HOLA';
        renderTimetable();
        runSearch();
      }
    });

    document.getElementById("ttLocation").addEventListener("change", () => {
      renderTimetable();
      runSearch();
    });
    document.getElementById("ttDayType").addEventListener("change", () => {
      renderTimetable();
      runSearch();
    });
    document.getElementById("ttSearchBtn").addEventListener("click", runSearch);
    document.getElementById("ttSearchInput").addEventListener("keydown", event => {
      if (event.key === "Enter") {
        runSearch();
      }
    });

  </script>
</body>
</html>